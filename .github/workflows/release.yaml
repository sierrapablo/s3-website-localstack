name: Create Release on Tag

on:
  push:
    tags:
      - "*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag and commit
        id: tag_info
        run: |
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          COMMIT_SHA=$(git rev-list -n 1 "$CURRENT_TAG")
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      - name: Ensure tag is on main
        run: |
          git fetch origin main
          TAG_COMMIT=${{ steps.tag_info.outputs.commit_sha }}
          if ! git merge-base --is-ancestor "$TAG_COMMIT" origin/main; then
            echo "Tag ${{ steps.tag_info.outputs.current_tag }} is not in main. Skipping release."
            exit 0
          fi

      - name: Get previous tag
        id: prev_tag
        run: |
          CURRENT_TAG=${{ steps.tag_info.outputs.current_tag }}
          PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")
          echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate what's changed
        id: changes
        run: |
          CURRENT_TAG=${{ steps.tag_info.outputs.current_tag }}
          PREV_TAG=${{ steps.prev_tag.outputs.previous_tag }}

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found. Showing all commits for $CURRENT_TAG"
            git log --oneline > changes.txt
          else
            git log --oneline "$PREV_TAG".."$CURRENT_TAG" > changes.txt
          fi

          cat changes.txt

          echo "changes<<EOF" >> $GITHUB_OUTPUT
          cat changes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.current_tag }}
          release_name: "Release ${{ steps.tag_info.outputs.current_tag }}"
          body: |
            Automatic release from main branch.
            Changes since last release:
            ${{ steps.changes.outputs.changes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}